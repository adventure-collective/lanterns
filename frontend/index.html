<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Lanterns frontend</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script src="three.min.js"></script>
    <script src="OrbitControls.js"></script>
		<script src="ReconnectingWebSocket.js"></script>
    <script>

      // todo from .json

      var N = 16

      var lantern_map = []

      for (var i = 0; i < N; i++) {
        lantern_map.push({
          x: Math.sin((i/N) * Math.PI * 2),
          y: .8,
          z: -Math.sin(((i/N) * Math.PI * 2) - Math.PI/2),
          r: 0.1,

          pixels: [
            i+1
          ]
          //
          // pixels: [
          //   'f1', 5,
          //   'f1', 6,
          //   'f1', 7,
          // ]
        })
      }

      console.log(lantern_map)


			const socket = new ReconnectingWebSocket(`ws://${location.host}`)

			const send = (data) => {
				if(socket.readyState == WebSocket.OPEN) {
					socket.send(data)
				} else {
					fetch('/send', {
		        method: 'POST',
		        body: data
		      })
				}
			}


			const colorStr = (color) =>
				String.fromCharCode.apply(String,
					// map components to 0->255
					[color.g,color.r,color.b].map(c => c * 255)

					// fade (for dev)
					.map(c => c * 0.05)
				)

			var scene = new THREE.Scene()
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 )

			var renderer = new THREE.WebGLRenderer({ antialias: true })
			renderer.setSize( window.innerWidth, window.innerHeight )
			renderer.setPixelRatio(window.devicePixelRatio)
      renderer.setClearColor(0xeeeeee)
			document.body.appendChild( renderer.domElement )


			// Build the lantern spheres
      const lanterns = lantern_map.map((d, i) => {

        var geometry = new THREE.SphereGeometry( d.r, 10, 10 )
        var material = new THREE.MeshBasicMaterial( { color: (0xffffff/N) * i } )
        var lantern = new THREE.Mesh( geometry, material )
        lantern.position.x = d.x
        lantern.position.y = d.y
        lantern.position.z = d.z
        scene.add( lantern )

        lantern.data = d

        return lantern

      })

			camera.position.z = 5

			var render = function () {
				requestAnimationFrame( render )
				renderer.render(scene, camera)
			}

			render()

      var payload = lanterns
        .map(l => colorStr(l.material.color))


			send(payload.join(''))

      var lastl = 0
      document.body.addEventListener('mousemove', (e) => {
        var l = Math.floor((e.clientY/400) * N)

        if(l !== lastl) {
					lastl = l

					console.log(l)

          lanterns
            .forEach((lantern, i) => {

							if(l > i) {
								lantern.material.color.setHSL((i-l)/N,.750,.50)
							} else {
								lantern.material.color.set(0)
							}
            })

            var payload = lanterns
              .map(l => colorStr(l.material.color))


					send(payload.join(''))

        }
      })



      controls = new THREE.OrbitControls( camera, renderer.domElement )

			controls.enableZoom = false
		</script>
	</body>
</html>
